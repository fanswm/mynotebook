Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-01-28T12:13:34+08:00

====== 延长树莓派上SD卡的使用寿命 ======
创建日期 星期四 28 一月 2021

延长树莓派上SD卡的使用寿命
2014年2月28日 Spoony 未分类 0

20140228224531692-0

最近我写了一篇为何我认为树梅派是最好的小型服务器的文章。其中提到了一个问题是SD卡存储。据说SD卡的写入次数是有限的，那么这是否意味着用树莓派当作服务器会存在一些问题呢？也许吧，目前只是个别文章报告了SD卡会报废，但并没有完全的定论。于是我开始寻找一些方法把SD卡的写入次数降到最低，理论上有助于延长它的使用寿命。

在一个SD卡上运行GNU/Linux的最佳实践
一张容量更大的卡   假设写操作在卡上的各个地方都有可能进行，这样越大的卡在同一区域多次书写的概率越小。对于大多数的树梅派GNU/Linux发行版来说，一张4GB的卡够用了，但8GB或者16GB从这个角度来看更合适。让我们把4GB提高到8GB，那么在同一区域进行写操作的概率会减少一半。
坚持选个好牌子  已经有许多文章都提到要坚持选择顶级品牌的SD卡。我没有整理出一份品牌列表也没有特别支持哪个品牌，但幸运的是已经有很多文章显示了顶级品牌和它们的报废率。
调整GNU/Linux写入到内存而不是SD卡上  这使用了一个叫“tmpfs”的功能，它是GNU/Linux提供的一个非常酷的玩意。Tmpfs能够像写入一个正常的文件系统一样让写操作写入内存中。它快捷，高效并且易于使用。下面会详细介绍。
SD卡设置为只读模式  这实际上把GNU/Linux变成了一个只读模式，类似于你从Live CD启动的GNU/Linux。这样阻止了任何的写操作从理论上来讲延长了SD卡的寿命。但这也有许多缺陷。首先，你得在配置上花点功夫，这已经超出了本文的范围。其次，所有的改动会在系统重启后消失因为它们没有写入SD卡里。对于我来说，GNU/Linux运行在只读模式实在是要命所以我不推荐这么极端的做法。
使用Tmpfs
如我前面所说，tmpfs会写入到内存中而不是本地磁盘(树梅派上实际是SD卡)。使用它非常简单。你要做的只是增加一个到/etc/fstab文件的入口(挂载你想写入到内存的文件夹到内存里)并且重启(这样每次服务开始写文件之前都会把这些文件夹先挂载到内存里)。

剩下的事情系统内核会替你搞定，把写操作写入到内存里的虚拟文件系统。这还有个巧妙之处，系统内核只会使用写操作所需数量的内存而不是整个挂载的大小。让我们举个例子，我想要把下面这一行加入到/etc/fstab文件中：

tmpfs /var/log tmpfs defaults,noatime,nosuid,mode=0755,size=100m 0 0
系统内核将会把/var/log挂载到内存中，然而在文件真正被写入到/var/log之前不会使用任何内存。当文件被写入到/var/log时，系统内核将会把它保存在内存里并且只占用用于保存文件的内存空间。当文件从/var/log中删除时，相对应的内存空间将被释放。

这意味着它只占用用于保存文件的内存空间，这是非常高效的。

在/etc/fstab中，你也可以为每个挂载指定内存配额。在上面的例子里，我们设置的是”size=100m”所以/var/log最多使用100m的内存空间。这是为了防止一个文件系统占用了全部内存以至于系统速度变慢甚至崩溃。通过运行”mount”命令，我们可以看到在上面的例子里/var/log被挂载为一个tmpfs在内存里的卷，大小是100MB。


Filesystem Size Used Avail Use% Mounted on
tmpfs 100M 596K 100M 1% /var/log
在GNU/Linux里有许多可能会频繁写入到地方。下面是一个我初步整理的应该可以适用于大多数发行版的列表。


tmpfs /tmp tmpfs defaults,noatime,nosuid,size=100m 0 0
tmpfs /var/tmp tmpfs defaults,noatime,nosuid,size=30m 0 0
tmpfs /var/log tmpfs defaults,noatime,nosuid,mode=0755,size=100m 0 0
tmpfs /var/run tmpfs defaults,noatime,nosuid,mode=0755,size=2m 0 0
tmpfs /var/spool/mqueue tmpfs defaults,noatime,nosuid,mode=0700,gid=12,size=30m 0 0
你看我使用了”size=”参数来避免试图保存大量的数据时占用大量内存的问题。出于安全和性能方面的考虑，”noatime”和”nosuid”参数也推荐设置，”mode=”和”gid=”对应的权限和用户组要与原来存在于SD卡上的文件系统保持一致。

恩，tmpfs也可以进行权限控制。通常情况下，所有在/etc/fstab下挂载的文件和标准的Unix/Linux文件没什么区别。所以即使因为一些原因挂载失效了，写操作也会成功写入到SD卡上。

需要记住的一点是所有挂载到tmpfs的文件将会在重启时丢失。所以上面的例子里/var/log文件会在关机时或重启时清空。所以不要把tmpfs用于那些你需要在重启后依然存在的文件。

我正在积极的使用这些设置，到目前为止结果还不错。时间会告诉我们这对于树莓派和/或者SD卡的寿命延续有何作用，但是现在已经有很多文章说能够正常运行很久，因为我们知道GNU/Linux不像其他操作系统一样需要频繁重启。上面的方法希望可以延长使用寿命，特别是你打算一年365天，每周7×24小时的开着树莓派。

文章标题：延长树莓派上SD卡的使用寿命 - 树莓派实验室
固定链接：https://shumeipai.nxez.com/2014/02/28/extend-the-life-of-raspberries-come-in-sd-card.html
